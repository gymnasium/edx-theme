version: 2
jobs:
  build: 
    working_directory: ~/edx-theme
    docker: 
      - image: circleci/python:2.7
    steps: 
      - run: echo '[edxapp-server]' > ~/inventory
      - run: echo $STAGING_SERVER >> ~/inventory
  deploy: 
    working_directory: ~/edx-theme
    docker: 
      - image: circleci/python:2.7
        environment:
          PIPENV_VENV_IN_PROJECT: true
    steps:
      - checkout
      - run: sudo chown -R circleci:circleci /usr/local/bin
      - run:
          name: Install pipenv
          command: sudo pip install pipenv && pipenv install
      - run: 
          name: Deploy to staging
          command: deactivate && ~/edx-theme/deploy/deploy_staging.sh
          no_output_timeout: 30m

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - deploy:
          # build has to be completed first
          requires:
            - build

          # only run this job on the develop branch
          filters:
            branches:
              only:
                - develop
                - /feature.*/